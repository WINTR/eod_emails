#!/usr/bin/env node

require('dotenv').config({ path: (__dirname + '/.env') });

var nodemailer = require("nodemailer"),
    moment = require('moment'),
    fs = require('fs'),
    path = require('path'),
    CronJob = require('cron').CronJob;


Mailer = {
  transporter: function(){
    return nodemailer.createTransport({
      service: 'Gmail',
      auth: {
        user: process.env.USER_EMAIL,
        pass: process.env.USER_PASS
      }
    })
  },

 emailText: fs.readFileSync(path.resolve(__dirname + '/today.txt')),

 mailOptions: {
    from: process.env.USER_EMAIL,
    to: process.env.EMAIL_TO,
    subject: 'EOD email: ' + moment().format('dddd, MMMM Do, YYYY'),
    text: this.emailText
  },

  sendMail: function(){
    var transporter = this.transporter();
    transporter.sendMail(this.mailOptions, function(error, info){
      if(error){
        return console.log(error);
      }
      console.log('Message sent: ' + info.response);
    });
  }
}

var CronRunner = {
  run: function(){
    var job = new CronJob({
      cronTime: '*/1 * * * *',
      onTick: function() {
        Mailer.sendMail()
      },
      start: true,
      timeZone: 'America/Los_Angeles'
    });
  }
}

CronRunner.run();
